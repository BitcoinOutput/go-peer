# HLS

> Hidden Lake Service.

## Description

The HLS is the core of the anonymous network, representing API functions for 
interacting with the network. HLS is based on the fifth stage of anonymity and represents the implementation of an abstract anonymous network based on queues.

## Config structure

```
"address.tcp"  Connection address for anonymity network, may be void
"address.http" Connection address for API functions
"services"     Map with redirects requests from network to services
"connections"  Connection addresses of the another nodes in network
"friends"      Friend addresses for send or receive messages over network
```

```json
{
	"address": {
		"tcp": "localhost:9571",
		"http": "localhost:9572"
	},
	"services": {
		"hidden-default-service": "localhost:8080"
	},
	"connections": [
		"localhost:9571"
	],
	"friends": [
		"Pub(go-peer/rsa){30818902818100C709DA63096CEDBA0DD6B5DD9465B412268C00509757A8EBD9096E17BEEC17C25A3A8F246E1591554CD214F4B27254EFA811F8BE441A03B37B3C8B390484C74C2294A4C895AA925D723E0065A877D4502CC010996863821E7348348E4E96CDD4CB7A852B2E2853C8FDEE556C4F89F6C3295EAC00DAEE86DD94E25F9703F368C70203010001}"
	]
}
```

## Request structure in HLS for internal services

```
Need encode this json to hex format
and put result to "hex_data" HLS API

"body" is base64 string
```

```json
{
	"method":"GET",
	"host":"hidden-default-service",
	"path":"/",
	"head":{
		"Accept": "application/json"
	},
	"body":"aGVsbG8sIHdvcmxkIQ=="
}
```

## Response structure from HLS API

```
"result" is string
"return" is int; 1 = success
```

```json
{
	"result":"",
	"return":1
}
```

## API

1. Get current connections
2. Get friends from config
3. Get public key of HLS node
4. Put message to network without response (broadcast)
5. Put message to network with response (request)

### 1. Get current connections

#### Request

```bash
curl -i -H 'Accept: application/json' http://localhost:9572/network/online
```

#### Response

```
HTTP/1.1 200 OK
Content-Type: application/json
Date: Fri, 07 Oct 2022 12:09:53 GMT
Content-Length: 55
```

```json
{"result":"127.0.0.1:35370,127.0.0.1:9571","return":1}
```

### 2. Get friends from config

#### Request

```bash
curl -i -H 'Accept: application/json' http://localhost:9572/node/friends
```

#### Response

```
HTTP/1.1 200 OK
Content-Type: application/json
Date: Fri, 07 Oct 2022 12:12:03 GMT
Content-Length: 323
```

```json
{"result":"Pub(go-peer/rsa){30818902818100C709DA63096CEDBA0DD6B5DD9465B412268C00509757A8EBD9096E17BEEC17C25A3A8F246E1591554CD214F4B27254EFA811F8BE441A03B37B3C8B390484C74C2294A4C895AA925D723E0065A877D4502CC010996863821E7348348E4E96CDD4CB7A852B2E2853C8FDEE556C4F89F6C3295EAC00DAEE86DD94E25F9703F368C70203010001}","return":1}
```

### 3. Get public key of HLS node

#### Request

```bash
curl -i -H 'Accept: application/json' http://localhost:9572/node/pubkey
```

#### Response

```
HTTP/1.1 200 OK
Content-Type: application/json
Date: Fri, 07 Oct 2022 12:13:21 GMT
Content-Length: 1095
```

```json
{"result":"Pub(go-peer/rsa){3082020A0282020100C8BEE8BEF61100D271F10A090995136E10F2E589836E7B75973EC60801B77283B67E6E48E2276E219E1C5B6EE27BA70998F45A33091020E727F11DD3AEBEF22D30F344DD7532340EB73969AE72EC991B454B533425A452036BFA0028018302C9CEA15B5CD6B22C3CCCDF274F90C5D75B0DB3D009194E4ABDA650D75005E959C40E4ED417AA8F8CACEFC07BB315460766FC90CDEBFAADBA5D2889E224CDD79D441E1B6DAAEDD27E26FE357EE03DE906CF3980209125E33C4F6CACEB7510BECAE0830491DD165DAE993CC6B6A8EF7E7D9ABB6F1607A592FDF57825E89375BD6077EC408D78890F7C2AF6210CF6F434F95E63191DB9B0F9D1C8BB08C5A2B9097EA36EAE0231931BF763CCA071A8331ED4D2614CF013A90CB4E4C481AB6F10CB1B97B748A0778823C76E3D54AC6F8CD4D11163440B6B00BCAA1583A1E62EE791B4C754A3122797E56D7023924EECFCD104B7D29A5EC1FB6CCAE3CCF1EB6E6B80F4FD5124FD4E09DA0A457AB53F97446A6BA8961061F7479088D21B90772969BB4E37B6583C99EE11643BB0FCE9F6176F7A7C63F7EB4B6DBD942516400ABF42448ED6AC93F68FA41879638F05E4DDA4F2E3EBC425A7E86EFC0C5BD4F05ADCD4741562CDCDB20476D86FE02E08C63DAE3AF033BE5D092B387DC8902E8F60457AEEB0C36ABE9589401BF3E42ADEDCDF0AE5C627FC695EAE25EB1CAA93621E8342005C630203010001}","return":1}
```

### 4. Put message to network without response (broadcast)

#### Request


```bash
#!/bin/bash

str2hex() {
    local str=${1:-""}
    local fmt="%02X"
    local chr
    local -i i
    for i in `seq 0 $((${#str}-1))`; do
        chr=${str:i:1}
        printf "${fmt}" "'${chr}"
    done
}

JSON_DATA='{
        "method":"POST",
        "host":"hidden-push-service",
        "path":"/push",
        "head":{
            "Accept": "application/json"
        },
        "body":"aGVsbG8sIHdvcmxkIQ=="
}';

BROADCAST_FORMAT="{
        \"receiver\":\"Pub(go-peer/rsa){3082020A0282020100E5B249D1547C5CD9A340CA8DB7DCB789657BAFD39FFA09351DF818CE99CED41451C6D5C7FD87C1CC027C6FC51A8C160DFE5029DA19F02D6E3A237995D0C64FFDEE8423A201663DEDA4574949C76EDE313EE8CC81C7451D602B133936CC045AA73218B2F6359777892A20C4041CAAB279B8718805A56E4C44CEC3BB7B084C1C8EF009E0BAD0F391B4204F96698526CF386B05F0B76CFE6FE278B023C5495D5E728500CFFCF5075DB6AC5214B97D7D14CECAB21E1F79E8AF844999760A040173B0D2DADDC0013A45C3423F127459E0FB70380E8469A7069C31DCD18760E2F0481F1CC2437BEFB801C394FE5D5AC1F985D52D44B980A9E64E46FDA1C3F2A739D2C473057506718EE9903C7E1FD584EE2261593C64543417846B3137098EEBE638AB54149A4EE2839A1DF243B593A3A952A2760885F62986E951C87FEBD99D47FBC7ECF6369DC94663A241ED72BBDB5AD86981ECE2862BE7B32C550A9D9FA141438BA3BA05EF68E52B18F9167CA3D10067CA350D2266385A8470927FAC05A3EBB8D0CB0C9F6430D205F933693478377F892506EAEA2ADE6A9DD736BC54583FF308068DB3B1A37B3ADA22695B27564A4822BDC143381617BCCD0CB7EFB21E1ACA4669B9A72AC3CAC6305407AA16DD50FA8AFEBA680D979242C521A2F9989008FAF6F691A55C34CF0988E4201536F95CF6C92E388278E1F70837C6CCFCC7ACD35272410203010001}\",
        \"hex_data\":\"$(str2hex "$JSON_DATA")\"
}";

curl localhost:9572/do/broadcast -X PUT --data "${BROADCAST_FORMAT}"
```

#### Response

```
HTTP/1.1 200 OK
Content-Type: application/json
Date: Fri, 07 Oct 2022 12:16:46 GMT
Content-Length: 43
```

```json
{"result":"success: broadcast","return":1}
```

### 5. Put message to network with response (request)

#### Request

```bash
#!/bin/bash

str2hex() {
    local str=${1:-""}
    local fmt="%02X"
    local chr
    local -i i
    for i in `seq 0 $((${#str}-1))`; do
        chr=${str:i:1}
        printf "${fmt}" "'${chr}"
    done
}

JSON_DATA='{
        "method":"POST",
        "host":"hidden-echo-service",
        "path":"/echo",
        "head":{
            "Accept": "application/json"
        },
        "body":"aGVsbG8sIHdvcmxkIQ=="
}';

REQUEST_FORMAT="{
        \"receiver\":\"Pub(go-peer/rsa){3082020A0282020100E5B249D1547C5CD9A340CA8DB7DCB789657BAFD39FFA09351DF818CE99CED41451C6D5C7FD87C1CC027C6FC51A8C160DFE5029DA19F02D6E3A237995D0C64FFDEE8423A201663DEDA4574949C76EDE313EE8CC81C7451D602B133936CC045AA73218B2F6359777892A20C4041CAAB279B8718805A56E4C44CEC3BB7B084C1C8EF009E0BAD0F391B4204F96698526CF386B05F0B76CFE6FE278B023C5495D5E728500CFFCF5075DB6AC5214B97D7D14CECAB21E1F79E8AF844999760A040173B0D2DADDC0013A45C3423F127459E0FB70380E8469A7069C31DCD18760E2F0481F1CC2437BEFB801C394FE5D5AC1F985D52D44B980A9E64E46FDA1C3F2A739D2C473057506718EE9903C7E1FD584EE2261593C64543417846B3137098EEBE638AB54149A4EE2839A1DF243B593A3A952A2760885F62986E951C87FEBD99D47FBC7ECF6369DC94663A241ED72BBDB5AD86981ECE2862BE7B32C550A9D9FA141438BA3BA05EF68E52B18F9167CA3D10067CA350D2266385A8470927FAC05A3EBB8D0CB0C9F6430D205F933693478377F892506EAEA2ADE6A9DD736BC54583FF308068DB3B1A37B3ADA22695B27564A4822BDC143381617BCCD0CB7EFB21E1ACA4669B9A72AC3CAC6305407AA16DD50FA8AFEBA680D979242C521A2F9989008FAF6F691A55C34CF0988E4201536F95CF6C92E388278E1F70837C6CCFCC7ACD35272410203010001}\",
        \"hex_data\":\"$(str2hex "$JSON_DATA")\"
}";

curl localhost:9572/do/request -X PUT --data "${REQUEST_FORMAT}"
```

#### Response

```
HTTP/1.1 200 OK
Content-Type: application/json
Date: Fri, 07 Oct 2022 12:18:34 GMT
Content-Length: 97
```

```json
{"result":"7b226563686f223a2268656c6c6f2c20776f726c6421222c2272657475726e223a317d0a","return":1}
```
